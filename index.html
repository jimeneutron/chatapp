<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatterChat</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
/* ===== VIEWPORT FIX ===== */
:root { --vh: 100vh; }
@supports (height: 100dvh) {
  :root { --vh: 100dvh; }
}

/* ===== GLOBAL ===== */
html, body {
  margin:0;
  height:100%;
  overflow:hidden;
  background:#121212;
  color:#e0e0e0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

:root{
  --sidebar-bg:#1f1f1f;
  --chat-bg:#181818;
  --mine:#4caf50;
  --their:#2c2c2c;
  --accent:#2196f3;
}

/* ===== LOGIN ===== */
.login-container{
  width:320px;
  margin:48px auto;
  padding:18px;
  background:var(--sidebar-bg);
  border-radius:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.login-container input, button{
  padding:10px;
  border-radius:8px;
  border:none;
}
.login-container input{background:#2c2c2c;color:#fff;}
.login-container button{background:var(--accent);color:#fff;font-weight:700;}

/* ===== LAYOUT ===== */
.chat-container{
  display:flex;
  width:100%;
  height:var(--vh);
  max-height:var(--vh);
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:min(260px,75vw);
  max-width:260px;
  min-width:220px;
  background:var(--sidebar-bg);
  padding:14px;
  overflow:hidden;
  touch-action:none;
}
.sidebar button{
  width:100%;
  margin-bottom:8px;
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:700;
}
#chatList{list-style:none;padding:0;margin:0;}
#chatList li{
  padding:8px;
  border-radius:8px;
  cursor:pointer;
}
#chatList li:hover{background:#2a2a2a}

/* ===== CHAT MAIN ===== */
.chat-main{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  background:var(--chat-bg);
}
.chat-top{
  padding:10px 16px;
  border-bottom:1px solid #222;
}

/* ===== MESSAGES ===== */
.messages{
  flex:1 1 auto;
  min-height:0;
  padding:16px;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.message{
  max-width:72%;
  padding:10px 14px;
  border-radius:12px;
  word-wrap:break-word;
}
.mine{align-self:flex-end;background:var(--mine);color:#fff;}
.their{align-self:flex-start;background:var(--their);}

.message img{
  max-width:220px;
  border-radius:8px;
  margin-top:6px;
}

/* ===== INPUT ===== */
.input-container{
  display:flex;
  gap:8px;
  padding:12px;
  background:var(--sidebar-bg);
  border-top:1px solid #222;
  flex-shrink:0;
}
#messageInput{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
}
.attach-btn{
  background:#444;
}
.attach-btn input{display:none}

/* ===== MOBILE ===== */
@media (max-width:800px){
  .sidebar{display:none}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginDiv" class="login-container">
  <h2>ChatterChat</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
</div>

<!-- CHAT -->
<div id="chatDiv" class="chat-container" style="display:none;">
  <div class="sidebar">
    <button id="newChatBtn">+ New Chat</button>
    <h3>Chats</h3>
    <ul id="chatList"></ul>
  </div>

  <div class="chat-main">
    <div class="chat-top" id="chatTitle">Global Chat</div>
    <div id="messages" class="messages"></div>

    <div class="input-container">
      <label class="attach-btn button">
        ðŸ“Ž
        <input type="file" id="fileInput">
      </label>
      <input id="messageInput" placeholder="Type a messageâ€¦">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAU1SHuBd24zNgP11D6aOPV3w0YFxz8bso",
  authDomain:"cchhatteerr.firebaseapp.com",
  projectId:"cchhatteerr"
});
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let currentChatId="global";
let unsub=null;
let pendingFile=null;

function enableNotifications(){
  if(Notification.permission==="default"){
    Notification.requestPermission();
  }
}

fileInput.onchange=e=>{
  pendingFile=e.target.files[0];
};

loginBtn.onclick=async()=>{
  const email=username.value.trim().toLowerCase().replace(/\s+/g,'_')+"@chat.local";
  await auth.signInWithEmailAndPassword(email,password.value);
};
signupBtn.onclick=async()=>{
  const email=username.value.trim().toLowerCase().replace(/\s+/g,'_')+"@chat.local";
  await auth.createUserWithEmailAndPassword(email,password.value);
};

auth.onAuthStateChanged(u=>{
  currentUser=u;
  if(u){
    loginDiv.style.display="none";
    chatDiv.style.display="flex";
    enableNotifications();
    loadChats();
    switchChat("global","Global Chat");
  }
});

function loadChats(){
  db.collection("chats")
    .where("members","array-contains",currentUser.uid)
    .onSnapshot(s=>{
      chatList.innerHTML="";
      s.forEach(d=>{
        const li=document.createElement("li");
        li.textContent=d.data().name;
        li.onclick=()=>switchChat(d.id,d.data().name);
        chatList.appendChild(li);
      });
    });
}

function switchChat(id,name){
  if(unsub) unsub();
  currentChatId=id;
  chatTitle.textContent=name;
  messages.innerHTML="";
  unsub=db.collection("chats").doc(id).collection("messages")
    .orderBy("time")
    .onSnapshot(s=>{
      messages.innerHTML="";
      s.forEach(d=>renderMessage(d.data()));
      messages.scrollTop=messages.scrollHeight;
    });
}

function renderMessage(m){
  const div=document.createElement("div");
  div.className="message "+(m.senderId===currentUser.uid?"mine":"their");

  if(m.fileData){
    if(m.fileType.startsWith("image/")){
      div.innerHTML=`<div>${m.text||""}</div><img src="${m.fileData}">`;
    } else {
      div.innerHTML=`<div>${m.text||""}</div>
      <a href="${m.fileData}" download="${m.fileName}" style="color:#9cf">ðŸ“„ ${m.fileName}</a>`;
    }
  } else {
    div.textContent=m.text||"";
  }

  messages.appendChild(div);

  if(
    m.senderId!==currentUser.uid &&
    document.visibilityState!=="visible" &&
    Notification.permission==="granted"
  ){
    new Notification(m.username||"New message",{body:m.text||"Attachment"});
  }
}

sendBtn.onclick=async()=>{
  const text=messageInput.value.trim();
  if(!text && !pendingFile) return;

  let fileData=null, fileType=null, fileName=null;

  if(pendingFile){
    const reader=new FileReader();
    reader.onload=async()=>{
      fileData=reader.result;
      fileType=pendingFile.type;
      fileName=pendingFile.name;
      await sendMessage(text,fileData,fileType,fileName);
      pendingFile=null;
      fileInput.value="";
    };
    reader.readAsDataURL(pendingFile);
  } else {
    await sendMessage(text);
  }
};

async function sendMessage(text,fileData,fileType,fileName){
  await db.collection("chats").doc(currentChatId).collection("messages").add({
    text,
    senderId:currentUser.uid,
    username:username.value,
    fileData,
    fileType,
    fileName,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  messageInput.value="";
}
</script>
</body>
</html>
