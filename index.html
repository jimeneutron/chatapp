<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatterChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ChatterChat">

<style>
/* =======================
   GLOBAL LOCKS
   ======================= */
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  background: #121212;
  color: #e0e0e0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* =======================
   VARIABLES
   ======================= */
:root{
  --bg:#121212;
  --sidebar:#1f1f1f;
  --chat:#181818;
  --accent:#2196f3;
  --mine:#4caf50;
  --their:#2c2c2c;
  --muted:#888;
  --radius:12px;
}

/* =======================
   LOGIN
   ======================= */
.login-container{
  width:320px;
  margin:60px auto;
  padding:18px;
  background:var(--sidebar);
  border-radius:var(--radius);
  display:flex;
  flex-direction:column;
  gap:10px;
}
.login-container input,
.login-container button{
  padding:10px;
  border-radius:8px;
  border:none;
}
.login-container input{
  background:#2c2c2c;
  color:#fff;
}
.login-container button{
  background:var(--accent);
  color:#fff;
  font-weight:600;
}

/* =======================
   LAYOUT
   ======================= */
.chat-container{
  display:flex;
  height:100vh;
}

/* ---- SIDEBAR (NO SCROLL EVER) ---- */
.sidebar{
  width:260px;
  background:var(--sidebar);
  padding:16px;
  overflow:hidden;
  touch-action:none;
  overscroll-behavior:none;
  box-shadow:2px 0 8px rgba(0,0,0,.5);
}
.sidebar button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  margin-bottom:10px;
}

/* ---- CHAT MAIN ---- */
.chat-main{
  flex:1;
  display:flex;
  flex-direction:column;
  background:var(--chat);
}

.chat-top{
  padding:12px 16px;
  border-bottom:1px solid #222;
  color:var(--muted);
}

/* ---- MESSAGES (ONLY SCROLL AREA) ---- */
.messages{
  flex:1;
  padding:16px;
  overflow-y:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.message{
  max-width:72%;
  padding:10px 14px;
  border-radius:12px;
  display:flex;
  gap:10px;
}
.message.mine{
  align-self:flex-end;
  background:var(--mine);
  color:#fff;
  flex-direction:row-reverse;
}
.message.their{
  align-self:flex-start;
  background:var(--their);
}

.pfp{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
}

/* ---- INPUT ---- */
.input-container{
  display:flex;
  gap:8px;
  padding:12px;
  background:var(--sidebar);
  border-top:1px solid #222;
}
.input-container input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:#fff;
}
.input-container button{
  padding:10px 14px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:700;
}

/* =======================
   MOBILE
   ======================= */
@media(max-width:800px){
  .sidebar{display:none}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginDiv" class="login-container">
  <h2>ChatterChat</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <p id="status" style="color:var(--muted)"></p>
</div>

<!-- CHAT -->
<div id="chatDiv" class="chat-container" style="display:none">
  <div class="sidebar">
    <button id="newChatBtn">+ New Chat</button>
    <button id="settingsBtn">⚙ Settings</button>
    <div id="chatList"></div>
  </div>

  <div class="chat-main">
    <div class="chat-top" id="chatTitle">Global Chat</div>
    <div id="messages" class="messages"></div>

    <div class="input-container">
      <input id="messageInput" placeholder="Type a message…">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ======================
   FIREBASE CONFIG
   ====================== */
firebase.initializeApp({
  apiKey: "AIzaSyAU1SHuBd24zNgP11D6aOPV3w0YFxz8bso",
  authDomain: "cchhatteerr.firebaseapp.com",
  projectId: "cchhatteerr"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ======================
   NOTIFICATIONS (iOS SAFE)
   ====================== */
async function enableNotifications(){
  if (!("Notification" in window)) return;
  if (Notification.permission === "default") {
    await Notification.requestPermission();
  }
}

/* ======================
   MESSAGE NOTIFICATION
   ====================== */
async function notify(msg){
  if (
    Notification.permission === "granted" &&
    document.visibilityState !== "visible"
  ){
    try{
      new Notification(msg.username || "New message", {
        body: msg.text || "New message",
        icon: "icons/icon-192.png"
      });
    }catch(e){}
  }
}

/* ======================
   AUTH
   ====================== */
const loginDiv = document.getElementById("loginDiv");
const chatDiv = document.getElementById("chatDiv");

loginBtn.onclick = async ()=>{
  await auth.signInWithEmailAndPassword(
    username.value + "@chat.local",
    password.value
  );
};

signupBtn.onclick = async ()=>{
  await auth.createUserWithEmailAndPassword(
    username.value + "@chat.local",
    password.value
  );
};

auth.onAuthStateChanged(u=>{
  if(u){
    loginDiv.style.display="none";
    chatDiv.style.display="flex";
    enableNotifications();
    listenMessages();
  }
});

/* ======================
   MESSAGES
   ====================== */
function listenMessages(){
  db.collection("messages").orderBy("time").onSnapshot(snap=>{
    messages.innerHTML="";
    snap.forEach(doc=>{
      const m = doc.data();
      const d = document.createElement("div");
      d.className="message " + (m.uid===auth.currentUser.uid?"mine":"their");
      d.innerHTML = `
        <img class="pfp" src="${m.pfp||'https://placehold.co/40'}">
        <div>${m.text}</div>
      `;
      messages.appendChild(d);
      notify(m);
    });
    messages.scrollTop = messages.scrollHeight;
  });
}

sendBtn.onclick = async ()=>{
  if(!messageInput.value.trim()) return;
  await db.collection("messages").add({
    text: messageInput.value,
    uid: auth.currentUser.uid,
    username: username.value,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  messageInput.value="";
};
</script>
</body>
</html>
