<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatterChat — Free (Firestore-only attachments & pfps)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ChatterChat">

<style>
/* ================= GLOBAL LOCK ================= */
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  background: #121212;
  color: #e0e0e0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* ================= VARIABLES ================= */
:root{
  --bg:#121212;
  --sidebar-bg:#1f1f1f;
  --chat-bg:#181818;
  --text:#e0e0e0;
  --muted:#888;
  --mine-bg:#4caf50;
  --their-bg:#2c2c2c;
  --accent:#2196f3;
  --radius:12px;
}

/* ================= LOGIN ================= */
.login-container{
  width:320px;
  margin:48px auto;
  display:flex;
  flex-direction:column;
  gap:10px;
  background:var(--sidebar-bg);
  padding:18px;
  border-radius:var(--radius);
}
.login-container input{
  padding:10px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:var(--text);
}
.login-container button{
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:600;
}

/* ================= LAYOUT ================= */
.chat-container{
  display:flex;
  height:100vh;
}

/* ===== SIDEBAR (LOCKED, NO SCROLL EVER) ===== */
.sidebar{
  width:260px;
  background:var(--sidebar-bg);
  padding:16px;
  overflow:hidden;
  overscroll-behavior:none;
  touch-action:none;
  box-shadow:2px 0 8px rgba(0,0,0,.5);
}
.sidebar h3{margin:6px 0}
.sidebar button{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  margin-bottom:10px;
}

/* ===== CHAT ===== */
.chat-main{
  flex:1;
  display:flex;
  flex-direction:column;
  background:var(--chat-bg);
}
.chat-top{
  padding:10px 18px;
  border-bottom:1px solid #222;
  color:var(--muted);
}

/* ===== MESSAGES (ONLY SCROLL AREA) ===== */
.messages{
  flex:1;
  padding:18px;
  overflow-y:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.message{
  max-width:72%;
  padding:10px 14px;
  border-radius:12px;
  display:flex;
  gap:10px;
}
.message.mine{
  align-self:flex-end;
  background:var(--mine-bg);
  color:#fff;
  flex-direction:row-reverse;
}
.message.their{
  align-self:flex-start;
  background:var(--their-bg);
}
.pfp{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
}

/* ===== INPUT ===== */
.input-container{
  display:flex;
  gap:8px;
  padding:12px 16px;
  background:var(--sidebar-bg);
  border-top:1px solid #222;
}
#messageInput{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#2c2c2c;
  color:var(--text);
}
.input-container button{
  padding:10px 14px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:#fff;
  font-weight:700;
}

/* ===== MOBILE ===== */
@media(max-width:800px){
  .sidebar{display:none}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginDiv" class="login-container">
  <h2>ChatterChat</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <p id="status" style="color:var(--muted)"></p>
</div>

<!-- CHAT -->
<div id="chatDiv" class="chat-container" style="display:none;">
  <div class="sidebar">
    <button id="newChatBtn">+ New Chat</button>
    <button id="settingsBtn">⚙ Settings</button>
    <h3>Chats</h3>
    <ul id="chatList"></ul>
  </div>

  <div class="chat-main">
    <div class="chat-top">
      <span id="chatTitle">Global Chat</span>
    </div>

    <div id="messages" class="messages"></div>

    <div class="input-container">
      <input id="messageInput" placeholder="Type a message…">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAU1SHuBd24zNgP11D6aOPV3w0YFxz8bso",
  authDomain: "cchhatteerr.firebaseapp.com",
  projectId: "cchhatteerr"
});
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= STATE ================= */
let currentUser = null;

/* ================= NOTIFICATIONS ================= */
async function enableNotifications(){
  if(!("Notification" in window)) return;
  if(Notification.permission === "default"){
    await Notification.requestPermission();
  }
}

/* ================= AUTH ================= */
loginBtn.onclick = async ()=>{
  const email = username.value.trim().toLowerCase().replace(/\s+/g,'_') + "@chat.local";
  await auth.signInWithEmailAndPassword(email, password.value);
};
signupBtn.onclick = async ()=>{
  const email = username.value.trim().toLowerCase().replace(/\s+/g,'_') + "@chat.local";
  await auth.createUserWithEmailAndPassword(email, password.value);
};

auth.onAuthStateChanged(async u=>{
  currentUser = u;
  if(u){
    loginDiv.style.display="none";
    chatDiv.style.display="flex";
    enableNotifications();
    listenMessages();
  } else {
    loginDiv.style.display="block";
    chatDiv.style.display="none";
  }
});

/* ================= MESSAGES ================= */
function listenMessages(){
  db.collection("chats").doc("global").collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      messages.innerHTML="";
      snap.forEach(doc=>{
        const m = doc.data();
        renderMessage(m);
      });
      messages.scrollTop = messages.scrollHeight;
    });
}

function renderMessage(m){
  const div = document.createElement("div");
  div.className = "message " + (m.senderId === currentUser.uid ? "mine" : "their");
  div.innerHTML = `
    <img class="pfp" src="${m.pfp || 'https://placehold.co/40'}">
    <div>${m.text || ""}</div>
  `;
  messages.appendChild(div);

  if(
    m.senderId !== currentUser.uid &&
    document.visibilityState !== "visible" &&
    Notification.permission === "granted"
  ){
    new Notification(m.username || "New message", {
      body: m.text || "New message",
      icon: m.pfp || "icons/icon-192.png"
    });
  }
}

sendBtn.onclick = async ()=>{
  const txt = messageInput.value.trim();
  if(!txt) return;

  await db.collection("chats").doc("global").collection("messages").add({
    text: txt,
    senderId: currentUser.uid,
    username: username.value,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  messageInput.value="";
};
</script>
</body>
</html>
