<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChatterChat â€” Full App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MyApp">
<style>
:root{
  --bg:#121212; --sidebar-bg:#1f1f1f; --chat-bg:#181818; --text:#e0e0e0;
  --muted:#888; --mine-bg:#4caf50; --their-bg:#2c2c2c; --accent:#2196f3;
  --border-radius:12px; --font-family:'Segoe UI',Tahoma, Geneva, Verdana, sans-serif;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:var(--font-family);}
body{background:var(--bg);color:var(--text);-webkit-overflow-scrolling: touch;}
h2,h3{margin:0}

/* LOGIN */
.login-container{
  width:360px;
  position:absolute; top:0; bottom:0; left:0; right:0;
  margin:auto; display:flex; flex-direction:column; gap:12px;
  padding:24px; background:var(--sidebar-bg); border-radius:12px;
  z-index:100;
}
.login-container input{
  padding:12px;border-radius:8px;border:none;outline:none;background:#2c2c2c;color:var(--text);
}
.login-container button{
  padding:12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:600;
}
.login-container button:disabled{
  background:#555; cursor:not-allowed; opacity:0.7;
}
#status{color:var(--muted);font-size:0.85rem;min-height:20px}

/* VERIFICATION UI */
.verification-section{
  background:#2c2c2c;border-radius:8px;padding:16px;margin-top:8px;
}
.verification-section h4{
  margin:0 0 10px 0;color:#ff9800;font-size:0.95rem;
}
.verification-section p{
  margin:0 0 12px 0;font-size:0.85rem;color:var(--muted);
}
.verification-section input{
  width:100%;padding:10px;border-radius:6px;border:none;background:#1f1f1f;color:var(--text);
  text-align:center;font-size:1.2rem;letter-spacing:4px;margin-bottom:12px;
}
.verification-section button{
  padding:8px 14px;border-radius:6px;border:none;background:#ff9800;color:#fff;cursor:pointer;font-size:0.85rem;
}
.verification-section button:hover{
  background:#f57c00;
}
.verified-badge{
  display:inline-flex;align-items:center;gap:6px;background:#4caf50;color:#fff;padding:4px 10px;border-radius:20px;font-size:0.8rem;margin-top:8px;
}

/* CODE RESEND TIMER */
.code-timer{
  font-size:0.8rem;color:var(--muted);margin-top:8px;
}
.code-timer span{
  color:#ff9800;font-weight:bold;
}

/* CHAT LAYOUT */
.chat-container{display:flex;height:100%;width:100%;overflow:hidden}
.sidebar{
  width:260px; background:var(--sidebar-bg); padding:16px;
  overflow:hidden;
  box-shadow:2px 0 8px rgba(0,0,0,0.5);
  display:flex; flex-direction:column;
}
.sidebar h3{margin-top:6px}
.add-chat-btn{width:100%;padding:10px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;margin-bottom:12px}
.add-chat-btn.secondary{background:#555}
.chat-main{flex:1;display:flex;flex-direction:column;background:var(--chat-bg)}
.chat-top{padding:10px 18px;border-bottom:1px solid #222;color:var(--muted)}
.messages{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:12px}

/* MESSAGE */
.message{max-width:72%;padding:10px 14px;border-radius:12px;word-wrap:break-word;display:flex;gap:10px;align-items:flex-start;position:relative}
.message.their{background:var(--their-bg);align-self:flex-start}
.message.mine{background:var(--mine-bg);align-self:flex-end;color:#fff;flex-direction:row-reverse}
.message .meta{font-size:0.75rem;color:var(--muted);margin-bottom:6px}
.pfp{width:36px;height:36px;border-radius:50%;object-fit:cover}
.message .content{display:flex;flex-direction:column}
.mention{color:var(--accent);font-weight:700}
.chat-img, .chat-video, .chat-audio{border-radius:10px;max-width:280px;margin-top:6px;display:block}

/* INPUT */
.input-container{display:flex;gap:8px;padding:12px 16px;background:var(--sidebar-bg);border-top:1px solid #222}
#messageInput{flex:1;padding:10px;border-radius:8px;border:none;background:#2c2c2c;color:var(--text);outline:none;font-size:1rem}
#sendBtn,#attachBtn{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
#sendBtn:hover,#attachBtn:hover{background:#1976d2}

/* MODALS */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:40}
.modal-content{background:var(--sidebar-bg);padding:18px;border-radius:12px;width:340px;max-height:80%;overflow:auto}
.user-item{padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer}
.user-item:hover{background:#333}
.user-item.selected{background:var(--accent);color:#fff}

/* SETTINGS ROW */
.settings-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.settings-row input[type="text"]{flex:1;padding:8px;border-radius:6px;border:none;background:#2c2c2c;color:var(--text)}
.small-btn{padding:8px 10px;border-radius:8px;border:none;background:#444;color:#fff;cursor:pointer}

/* RESPONSIVE */
@media(max-width:800px){.sidebar{display:none}.chat-container{flex-direction:column}.chat-main{height:100%}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="login-container">
  <h2>ChatterChat</h2>
  
  <!-- Step 1: Registration Form -->
  <div id="registerStep">
    <input id="emailInput" type="email" placeholder="Email address">
    <input id="username" placeholder="Username (display name)">
    <input id="password" type="password" placeholder="Password (min 6 characters)">
    <div>
      <label style="font-size:0.9rem;color:var(--muted)">Profile picture (optional)</label><br>
      <input id="pfpInput" type="file" accept="image/*">
      <div id="pfpPreviewWrap" style="margin-top:8px">
        <img id="pfpPreview" src="" alt="" style="width:64px;height:64px;border-radius:50%;object-fit:cover;display:none">
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="loginBtn">Login</button>
      <button id="signupBtn">Sign Up</button>
    </div>
  </div>
  
  <!-- Step 2: Verification Code Input -->
  <div id="verifyStep" class="verification-section" style="display:none;">
    <h4>Enter Verification Code</h4>
    <p>A 6-digit code has been sent to <span id="verifyEmail"></span></p>
    <input id="verificationCode" type="text" maxlength="6" placeholder="000000">
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button id="verifyCodeBtn">Verify Code</button>
      <button id="resendCodeBtn">Resend Code</button>
    </div>
    <div id="codeTimer" class="code-timer">Resend available in <span id="timerCount">30</span>s</div>
  </div>
  
  <!-- Verification Status -->
  <div id="verificationStatus" class="verification-section" style="display:none;">
    <h4>Verification Pending</h4>
    <p>Please verify your email to access the chat.</p>
    <button id="continueVerifyBtn">Continue Verification</button>
  </div>
  
  <div id="verifiedBadge" class="verified-badge" style="display:none;">
    <span>&#10003;</span> Email Verified
  </div>
  
  <p id="status"></p>
</div>

<!-- CHAT -->
<div id="chatDiv" class="chat-container" style="display:none;">
  <div class="sidebar">
    <button id="newChatBtn" class="add-chat-btn">+ New Chat</button>
    <button id="settingsBtn" class="add-chat-btn secondary">Settings</button>
    <h3>Chats</h3>
    <ul id="chatList" style="padding:0;margin:0;flex:1;overflow:auto"></ul>
    <hr style="border:0;border-top:1px solid #222;margin:14px 0">
    <h3>Users</h3>
    <div id="shortUserList" style="display:flex;flex-direction:column;gap:6px;overflow:auto;flex:1"></div>
  </div>

  <div class="chat-main">
    <div class="chat-top">
      <span id="chatTitle">Global Chat</span>
    </div>
    <div id="messages" class="messages"></div>

    <div class="input-container">
      <input id="messageInput" placeholder="Type a message... (use @username to mention)">
      <button id="attachBtn">Attachments</button>
      <input id="fileInput" type="file" style="display:none">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div id="newChatModal" class="modal">
  <div class="modal-content">
    <h3>Create Chat</h3>
    <input id="chatNameInput" placeholder="Chat name" style="width:100%;padding:8px;border-radius:6px;border:none;background:#2c2c2c;color:var(--text)">
    <p style="color:var(--muted);margin-top:8px">Select participants</p>
    <div id="userList" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="createChatBtn" class="small-btn">Create</button>
      <button id="cancelCreateChatBtn" class="small-btn">Cancel</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h3>User Settings</h3>
    <div class="settings-row">
      <img id="settingsPfpPreview" src="" style="width:72px;height:72px;border-radius:50%;object-fit:cover;display:block">
      <div style="flex:1">
        <label style="font-size:0.9rem;color:var(--muted)">Username</label>
        <input id="settingsUsername" type="text" style="width:100%;padding:8px;border-radius:6px;border:none;background:#2c2c2c;color:var(--text)">
        <label style="font-size:0.9rem;color:var(--muted);margin-top:8px;display:block">Change profile picture</label>
        <input id="settingsPfp" type="file" accept="image/*">
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="saveSettingsBtn" class="small-btn">Save</button>
      <button id="closeSettingsBtn" class="small-btn">Close</button>
    </div>
    <div style="margin-top:12px;color:var(--muted);font-size:0.9rem">
      <div>Your UID: <span id="myUid"></span></div>
      <div style="margin-top:6px"><button id="logoutBtn" class="small-btn">Log out</button></div>
    </div>
  </div>
</div>

<!-- FIREBASE & EMAILJS -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>  
/* =========================
   FIREBASE CONFIG
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAU1SHuBd24zNgP11D6aOPV3w0YFxz8bso",
  authDomain: "cchhatteerr.firebaseapp.com",
  projectId: "cchhatteerr",
  storageBucket: "cchhatteerr.firebasestorage.app",
  messagingSenderId: "462333840338",
  appId: "1:462333840338:web:81b2a196992783a7ea160b",
  measurementId: "G-H9M070PFZB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   EMAILJS CONFIG
========================= */
const EMAILJS_PUBLIC_KEY = "nuZd1_wjNLq2YXtzr";
emailjs.init(EMAILJS_PUBLIC_KEY);

/* =========================
   DOM ELEMENTS
========================= */
const loginDiv = document.getElementById('loginDiv');
const chatDiv = document.getElementById('chatDiv');
const registerStep = document.getElementById('registerStep');
const verifyStep = document.getElementById('verifyStep');
const verifyEmail = document.getElementById('verifyEmail');
const verificationCode = document.getElementById('verificationCode');
const emailInput = document.getElementById('emailInput');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const pfpInput = document.getElementById('pfpInput');
const pfpPreview = document.getElementById('pfpPreview');
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const statusEl = document.getElementById('status');
const verificationStatus = document.getElementById('verificationStatus');
const verifiedBadge = document.getElementById('verifiedBadge');
const verifyCodeBtn = document.getElementById('verifyCodeBtn');
const resendCodeBtn = document.getElementById('resendCodeBtn');
const continueVerifyBtn = document.getElementById('continueVerifyBtn');
const codeTimer = document.getElementById('codeTimer');
const timerCount = document.getElementById('timerCount');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const chatListEl = document.getElementById('chatList');
const newChatBtn = document.getElementById('newChatBtn');
const newChatModal = document.getElementById('newChatModal');
const userListEl = document.getElementById('userList');
const chatNameInput = document.getElementById('chatNameInput');
const createChatBtn = document.getElementById('createChatBtn');
const cancelCreateChatBtn = document.getElementById('cancelCreateChatBtn');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const settingsUsername = document.getElementById('settingsUsername');
const settingsPfp = document.getElementById('settingsPfp');
const settingsPfpPreview = document.getElementById('settingsPfpPreview');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const myUidEl = document.getElementById('myUid');
const shortUserList = document.getElementById('shortUserList');

/* =========================
   APP STATE
========================= */
let currentUser = null;
let currentChatId = 'global';
let allUsers = [];
let unsubscribeMsg = null;
let pendingEmail = null;
let pendingUsername = null;
let pendingPassword = null;
let pendingPfpData = null;
let pendingUid = null;
let resendTimer = null;
const ATTACHMENT_SIZE_LIMIT = 2048*2048;

/* =========================
   HELPERS
========================= */
function normalizeUsername(u){ return u.trim().toLowerCase().replace(/\s+/g,'_'); }
function formatTime(d){
  if(!d) return '';
  const dt = d.toDate ? d.toDate() : d;
  const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day=String(dt.getDate()).padStart(2,'0');
  const hh=String(dt.getHours()).padStart(2,'0'), mm=String(dt.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${day} ${hh}:${mm}`;
}
function showModal(m){ m.style.display='flex' }
function hideModal(m){ m.style.display='none' }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=e=>rej(e); r.readAsDataURL(file); }); }

/* =========================
   GENERATE 6-DIGIT CODE
========================= */
function generateVerificationCode(){
  return Math.floor(100000 + Math.random() * 900000).toString();
}

/* =========================
   SEND VERIFICATION CODE VIA EMAILJS
========================= */
async function sendVerificationCode(email, code){
  try{
    const templateParams = {
      to_email: email,
      verification_code: code,
      from_name: 'ChatterChat',
      message: `Your verification code is: ${code}`
    };

    const response = await emailjs.send(
      'default_service',
      'template_default',
      templateParams
    );
    return { success: true, response };
  }catch(err){
    console.error('EmailJS error:', err);
    return { success: false, error: err.message };
  }
}

/* =========================
   STORE VERIFICATION CODE IN FIRESTORE
========================= */
async function storeVerificationCode(uid, email, code){
  const codeExpiry = Date.now() + 5 * 60 * 1000; // 5 minutes
  await db.collection('verification_codes').doc(uid).set({
    email: email,
    code: code,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    expiresAt: codeExpiry,
    verified: false
  });
}

/* =========================
   VERIFY CODE
========================= */
async function verifyCode(uid, inputCode){
  try{
    const doc = await db.collection('verification_codes').doc(uid).get();
    if(!doc.exists){
      return { valid: false, error: 'No verification code found. Please request a new code.' };
    }

    const data = doc.data();
    
    // Check if expired
    if(Date.now() > data.expiresAt){
      await db.collection('verification_codes').doc(uid).delete();
      return { valid: false, error: 'Verification code has expired. Please request a new code.' };
    }

    // Check if already verified
    if(data.verified){
      return { valid: true, alreadyVerified: true };
    }

    // Check code match
    if(inputCode !== data.code){
      return { valid: false, error: 'Invalid verification code. Please try again.' };
    }

    // Mark as verified
    await db.collection('verification_codes').doc(uid).update({
      verified: true,
      verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    return { valid: true };
  }catch(err){
    return { valid: false, error: 'Error verifying code: ' + err.message };
  }
}

/* =========================
   RESEND CODE TIMER
========================= */
function startResendTimer(){
  let seconds = 30;
  codeTimer.style.display = 'block';
  resendCodeBtn.disabled = true;
  
  timerCount.textContent = seconds;
  
  resendTimer = setInterval(()=>{
    seconds--;
    timerCount.textContent = seconds;
    
    if(seconds <= 0){
      clearInterval(resendTimer);
      resendTimer = null;
      codeTimer.style.display = 'none';
      resendCodeBtn.disabled = false;
    }
  }, 1000);
}

/* =========================
   MESSAGE FILTER
========================= */
let BLOCKED_STRINGS = [
  "nigg",
];

function containsBlockedString(text){
  const t = text.toLowerCase();
  return BLOCKED_STRINGS.some(b => t.includes(b.toLowerCase()));
}

/* =========================
   PROFILE PICTURE PREVIEW
========================= */
pfpInput.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = await fileToDataURL(f); pfpPreview.src=url; pfpPreview.style.display='block';
});

/* =========================
   SIGN UP
========================= */
signupBtn.addEventListener('click', async ()=>{
  const email = emailInput.value.trim();
  const username = usernameInput.value.trim();
  const password = passwordInput.value;
  
  if(!email||!username||!password){
    statusEl.textContent = 'Please fill in all fields';
    return;
  }
  
  if(password.length < 6){
    statusEl.textContent = 'Password must be at least 6 characters';
    return;
  }
  
  if(username.length < 2){
    statusEl.textContent = 'Username must be at least 2 characters';
    return;
  }
  
  try{
    // Create Firebase user (will need email verification)
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = cred.user.uid;
    
    // Generate verification code
    const code = generateVerificationCode();
    
    // Store profile data temporarily (unverified)
    let pfpData = "";
    if(pfpInput.files[0]){
      pfpData = await fileToDataURL(pfpInput.files[0]);
    }
    
    await db.collection('users').doc(uid).set({
      username: username,
      displayUsername: normalizeUsername(username),
      password: '',
      pfp: pfpData,
      email: email,
      emailVerified: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Store verification code
    await storeVerificationCode(uid, email, code);
    
    // Send verification code via EmailJS
    const emailResult = await sendVerificationCode(email, code);
    
    if(!emailResult.success){
      // If email fails, still allow verification for demo purposes
      console.warn('Email sending failed, code is:', code);
      statusEl.textContent = 'Note: Email service unavailable. For testing, use code: ' + code;
    }else{
      statusEl.textContent = 'Verification code sent to your email!';
    }
    
    // Store pending data
    pendingEmail = email;
    pendingUsername = username;
    pendingPassword = password;
    pendingPfpData = pfpData;
    pendingUid = uid;
    
    // Show verification UI
    registerStep.style.display = 'none';
    verifyStep.style.display = 'block';
    verifyEmail.textContent = email;
    verificationCode.value = '';
    verificationCode.focus();
    
    // Start resend timer
    startResendTimer();
    
  }catch(err){
    if(err.code === 'auth/email-already-in-use'){
      statusEl.textContent = 'Email already registered. Please login or use a different email.';
    }else{
      statusEl.textContent = 'Error: ' + err.message;
    }
    currentUser = null;
  }
});

/* =========================
   VERIFY CODE BUTTON
========================= */
verifyCodeBtn.addEventListener('click', async ()=>{
  const code = verificationCode.value.trim();
  
  if(code.length !== 6){
    statusEl.textContent = 'Please enter the 6-digit code';
    return;
  }
  
  try{
    const result = await verifyCode(pendingUid, code);
    
    if(result.valid){
      // Update user document as verified
      await db.collection('users').doc(pendingUid).update({
        emailVerified: true
      });
      
      // Clear verification data
      await db.collection('verification_codes').doc(pendingUid).delete();
      
      statusEl.textContent = 'Email verified successfully!';
      verifiedBadge.style.display = 'inline-flex';
      
      // Initialize chat
      initChat();
    }else{
      statusEl.textContent = result.error;
    }
  }catch(err){
    statusEl.textContent = 'Error: ' + err.message;
  }
});

/* =========================
   RESEND CODE BUTTON
========================= */
resendCodeBtn.addEventListener('click', async ()=>{
  if(!pendingEmail || !pendingUid) return;
  
  try{
    // Generate new code
    const code = generateVerificationCode();
    
    // Update verification code in Firestore
    await storeVerificationCode(pendingUid, pendingEmail, code);
    
    // Send new code via EmailJS
    const emailResult = await sendVerificationCode(pendingEmail, code);
    
    if(!emailResult.success){
      console.warn('Email sending failed, new code is:', code);
      statusEl.textContent = 'Code resent. For testing, use code: ' + code;
    }else{
      statusEl.textContent = 'New verification code sent!';
    }
    
    // Restart timer
    startResendTimer();
    
  }catch(err){
    statusEl.textContent = 'Error resending code: ' + err.message;
  }
});

/* =========================
   AUTO-advance on code entry
========================= */
verificationCode.addEventListener('input', (e)=>{
  if(e.target.value.length === 6){
    verifyCodeBtn.click();
  }
});

/* =========================
   LOGIN
========================= */
loginBtn.addEventListener('click', async ()=>{
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  
  if(!email||!password){
    statusEl.textContent = 'Please enter email and password';
    return;
  }
  
  try{
    const cred = await auth.signInWithEmailAndPassword(email, password);
    currentUser = cred.user;
    
    // Check if email is verified in Firestore
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.data();
    
    if(userData && userData.emailVerified){
      verifiedBadge.style.display = 'inline-flex';
      initChat();
    }else{
      // User exists but not verified
      statusEl.textContent = 'Please verify your email to access the chat.';
      verifiedBadge.style.display = 'none';
      await auth.signOut();
      currentUser = null;
      
      // Show verification UI for existing user
      registerStep.style.display = 'none';
      verifyStep.style.display = 'block';
      verifyEmail.textContent = email;
      verificationCode.value = '';
      pendingEmail = email;
      pendingUid = currentUser.uid;
    }
  }catch(err){
    statusEl.textContent = 'Invalid credentials';
    currentUser = null;
  }
});

/* =========================
   CONTINUE VERIFICATION (for existing users)
========================= */
continueVerifyBtn.addEventListener('click', async ()=>{
  if(!currentUser) return;
  
  const email = currentUser.email;
  const uid = currentUser.uid;
  
  // Generate and send new code
  const code = generateVerificationCode();
  await storeVerificationCode(uid, email, code);
  
  const emailResult = await sendVerificationCode(email, code);
  
  if(!emailResult.success){
    console.warn('Email sending failed, code is:', code);
    statusEl.textContent = 'For testing, use code: ' + code;
  }else{
    statusEl.textContent = 'Verification code sent!';
  }
  
  registerStep.style.display = 'none';
  verifyStep.style.display = 'block';
  verifyEmail.textContent = email;
  verificationCode.value = '';
  pendingEmail = email;
  pendingUid = uid;
  
  startResendTimer();
});

/* =========================
   AUTH STATE LISTENER
========================= */
auth.onAuthStateChanged(async user=>{
  currentUser = user;
  
  if(user){
    // Check verification status in Firestore
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.data();
    
    if(userData && userData.emailVerified){
      // User is verified
      verifiedBadge.style.display = 'inline-flex';
      verificationStatus.style.display = 'none';
      verifyStep.style.display = 'none';
      registerStep.style.display = 'none';
      initChat();
    }else{
      // Not verified - show verification UI
      verifiedBadge.style.display = 'none';
      registerStep.style.display = 'none';
      verifyStep.style.display = 'none';
      verificationStatus.style.display = 'block';
      loginDiv.style.display = 'block';
      chatDiv.style.display = 'none';
      statusEl.textContent = 'Please verify your email to access the chat.';
    }
  }else{
    // Not authenticated - show login form
    verifiedBadge.style.display = 'none';
    verificationStatus.style.display = 'none';
    verifyStep.style.display = 'none';
    registerStep.style.display = 'block';
    loginDiv.style.display = 'block';
    chatDiv.style.display = 'none';
    statusEl.textContent = '';
  }
});

/* =========================
   INIT CHAT
========================= */
async function initChat(){
  const globalRef = db.collection('chats').doc('global');
  const g = await globalRef.get(); if(!g.exists) await globalRef.set({name:'Global',members:[]});
  loginDiv.style.display='none'; chatDiv.style.display='flex';
  await loadUsers(); listenChats(); switchChat('global');
  if(Notification.permission!=='granted') Notification.requestPermission();
  renderShortUserList();
}

/* =========================
   USERS
========================= */
async function loadUsers(){
  const snap = await db.collection('users').get();
  allUsers = snap.docs.map(d=>({id:d.id,...d.data()}));
  allUsers.forEach(u=>{if(!u.username) u.username='unknown';});
}

function renderShortUserList(){
  shortUserList.innerHTML='';
  allUsers.forEach(u=>{
    const d=document.createElement('div'); d.style.display='flex'; d.style.alignItems='center'; d.style.gap='8px';
    const img=document.createElement('img'); img.src=u.pfp||'https://placehold.co/40'; img.style.width='28px'; img.style.height='28px'; img.style.borderRadius='50%'; img.style.objectFit='cover';
    const span=document.createElement('div'); span.textContent=u.username; span.style.color='var(--muted)'; span.style.fontSize='0.95rem';
    d.appendChild(img); d.appendChild(span); shortUserList.appendChild(d);
  });
}

/* =========================
   CHATS & MESSAGES
========================= */
function listenChats(){
  db.collection('chats').onSnapshot(snap=>{
    chatListEl.innerHTML='';
    const liGlobal=document.createElement('li'); liGlobal.textContent='Global Chat'; liGlobal.dataset.id='global';
    liGlobal.style.listStyle='none'; liGlobal.style.padding='10px'; liGlobal.style.borderRadius='8px'; liGlobal.style.cursor='pointer';
    if(currentChatId==='global') liGlobal.style.background='var(--accent)';
    liGlobal.addEventListener('click',()=>switchChat('global'));
    chatListEl.appendChild(liGlobal);
    snap.docs.forEach(doc=>{
      const data=doc.data();
      if(data.members && currentUser && data.members.includes(currentUser.uid)){
        const li=document.createElement('li'); li.textContent=data.name; li.dataset.id=doc.id;
        li.style.padding='10px'; li.style.borderRadius='8px'; li.style.cursor='pointer';
        if(doc.id===currentChatId) li.style.background='var(--accent)';
        li.addEventListener('click',()=>switchChat(doc.id));
        chatListEl.appendChild(li);
      }
    });
  });
}

function switchChat(chatId){
  currentChatId=chatId;
  document.getElementById('chatTitle').textContent=(chatId=='global')?'Global Chat':'Chat: ' + chatId;
  Array.from(chatListEl.children).forEach(li=>li.style.background='');
  const found=Array.from(chatListEl.children).find(li=>li.dataset && li.dataset.id===chatId);
  if(found) found.style.background='var(--accent)';
  listenMessages(chatId);
}

function listenMessages(chatId){
  if(unsubscribeMsg) unsubscribeMsg();
  const coll = (chatId=='global')? db.collection('chats').doc('global').collection('messages') : db.collection('chats').doc(chatId).collection('messages');
  unsubscribeMsg=coll.orderBy('time').onSnapshot(snapshot=>{
    messagesEl.innerHTML='';
    snapshot.docs.forEach(doc=>addMessageToDOM(doc.data()));
  });
}

async function addMessageToDOM(msg){
  const div=document.createElement('div'); div.classList.add('message');
  div.classList.add(msg.senderId==(currentUser&&currentUser.uid)?'mine':'their');
  let text=msg.text||''; text=text.replace(/@([^\s@]+)/g,(m,u)=>`<span class="mention">@${u}</span>`);
  if(msg.type=='file'&&msg.fileData){
    const mime=msg.fileType||'';
    if(mime.startsWith('image/')) text+=`<img src="${msg.fileData}" class="chat-img">`;
    else if(mime.startsWith('video/')) text+=`<video src="${msg.fileData}" class="chat-video" controls></video>`;
    else if(mime.startsWith('audio/')) text+=`<audio src="${msg.fileData}" class="chat-audio" controls></audio>`;
    else text+=`<a href="${msg.fileData}" download="${msg.fileName}">Attachment ${msg.fileName}</a>`;
  }
  const pfpSrc=msg.pfp||'https://placehold.co/40';
  div.innerHTML=`<img src="${msg.username||'unknown'}" class="pfp"><div class="content"><div class="meta">${msg.username||'unknown'}${msg.time?'- '+formatTime(msg.time):''}</div><div class="body">${text}</div></div>`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
  if(currentUser && msg.senderId!==currentUser.uid){
    const shouldNotify = document.visibilityState!=='visible';
    if(shouldNotify && Notification.permission==='granted'){
      try{ new Notification(msg.username,{body:msg.text||msg.fileName||'New message',icon:pfpSrc}); }catch(e){}
    }
  }
}

/* =========================
   SEND & ATTACHMENTS
========================= */
messageInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendBtn.click();});
sendBtn.addEventListener('click',async ()=>{
  if(!currentUser) return;
  const text=messageInput.value.trim(); if(!text) return;
  
  // Blocked string check
  if(containsBlockedString(text)){
    alert("Your message contains a blocked word or phrase.");
    return;
  }

  const mentioned=(text.match(/@([^\s@]+)/g)||[]).map(s=>s.slice(1));
  const userDoc=await db.collection('users').doc(currentUser.uid).get();
  const u=userDoc.exists?userDoc.data():{username:usernameInput.value||'me',pfp:''};
  const coll=(currentChatId=='global')?db.collection('chats').doc('global').collection('messages'):db.collection('chats').doc(currentChatId).collection('messages');
  await coll.add({text,type:'text',senderId:currentUser.uid,username:u.username,pfp:u.pfp,mentions:mentioned,time:firebase.firestore.FieldValue.serverTimestamp()});
  messageInput.value='';
});

attachBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',async ()=>{
  const file=fileInput.files[0]; if(!file) return;
  if(file.size>ATTACHMENT_SIZE_LIMIT){ alert('File too big.'); fileInput.value=''; return; }
  const dataUrl=await fileToDataURL(file);
  const userDoc=await db.collection('users').doc(currentUser.uid).get();
  const u=userDoc.exists?userDoc.data():{username:usernameInput.value||'me',pfp:''};
  const coll=(currentChatId=='global')?db.collection('chats').doc('global').collection('messages'):db.collection('chats').doc(currentChatId).collection('messages');
  await coll.add({text:'',type:'file',fileData:dataUrl,fileType:file.type,fileName:file.name,senderId:currentUser.uid,username:u.username,pfp:u.pfp,mentions:[],time:firebase.firestore.FieldValue.serverTimestamp()});
  fileInput.value='';
});

/* =========================
   NEW CHAT MODAL
========================= */
newChatBtn.addEventListener('click',async ()=>{ await loadUsers(); renderUserSelection(); showModal(newChatModal);});
cancelCreateChatBtn.addEventListener('click',()=>hideModal(newChatModal));
function renderUserSelection(){ userListEl.innerHTML=''; allUsers.forEach(u=>{ const div=document.createElement('div'); div.className='user-item'; div.textContent=u.username; div.dataset.id=u.id; div.addEventListener('click',()=>div.classList.toggle('selected')); userListEl.appendChild(div);});}
createChatBtn.addEventListener('click',async ()=>{
  const selected=Array.from(userListEl.querySelectorAll('.user-item.selected')).map(el=>el.dataset.id);
  if(selected.length===0){ alert('Select at least one user'); return; }
  selected.push(currentUser.uid);
  const name=chatNameInput.value.trim()||'Group Chat';
  await db.collection('chats').add({name,members:selected});
  hideModal(newChatModal); chatNameInput.value='';
});

/* =========================
   SETTINGS MODAL
========================= */
settingsBtn.addEventListener('click',async ()=>{
  if(!currentUser) return;
  const doc=await db.collection('users').doc(currentUser.uid).get();
  const d=doc.exists?doc.data():{};
  settingsUsername.value=d.username||usernameInput.value||'';
  settingsPfpPreview.src=d.pfp||'https://placehold.co/80'; settingsPfpPreview.style.display='block';
  myUidEl.textContent=currentUser.uid; showModal(settingsModal);
});
closeSettingsBtn.addEventListener('click',()=>hideModal(settingsModal));
settingsPfp.addEventListener('change',async e=>{ if(!e.target.files[0]) return; settingsPfpPreview.src=await fileToDataURL(e.target.files[0]);});
saveSettingsBtn.addEventListener('click',async ()=>{
  if(!currentUser) return;
  const updates={}; if(settingsUsername.value.trim()) updates.username=settingsUsername.value.trim();
  if(settingsPfpPreview.src) updates.pfp=settingsPfpPreview.src;
  await db.collection('users').doc(currentUser.uid).update(updates);
  await loadUsers(); renderShortUserList(); hideModal(settingsModal); alert('Saved!');
});

/* =========================
   LOGOUT
========================= */
document.getElementById('logoutBtn').addEventListener('click',async ()=>{
  if(resendTimer){
    clearInterval(resendTimer);
    resendTimer = null;
  }
  await auth.signOut(); location.reload();
});

/* =========================
   CLOSE MODALS ON BG CLICK
========================= */
[ newChatModal, settingsModal ].forEach(mod=>{ mod.addEventListener('click', e=>{ if(e.target===mod) hideModal(mod); }); });

/* =========================
   ADMIN CONFIG
========================= */
const ADMINS = ['dxR5Xh1YXhUhihiIeuOOuYtZ6ql2',
               'Ef9sxnsb8yP19OW4loCSAqUZvxy2'];
function isAdmin(uid){ return ADMINS.includes(uid); }

/* =========================
   RENDER ADMIN BAN BUTTON
========================= */
function renderAdminControls(msg, msgDiv){
  if(!currentUser || !isAdmin(currentUser.uid)) return;
  const banBtn = document.createElement('button');
  banBtn.textContent = 'Ban User';
  banBtn.style.marginLeft = '8px';
  banBtn.style.padding = '4px 6px';
  banBtn.style.fontSize = '0.75rem';
  banBtn.style.borderRadius = '6px';
  banBtn.style.border = 'none';
  banBtn.style.cursor = 'pointer';
  banBtn.style.background = '#d32f2f';
  banBtn.style.color = '#fff';
  banBtn.addEventListener('click', async ()=>{
    const confirmBan = confirm(`Ban user ${msg.username} and their device?`);
    if(!confirmBan) return;
    await db.collection('users').doc(msg.senderId).update({
      banned: true,
      banReason: 'Violation',
      deviceId: msg.deviceId || DEVICE_ID
    });
    alert(`User ${msg.username} banned!`);
  });
  msgDiv.appendChild(banBtn);
}

/* =========================
   UPDATED addMessageToDOM
========================= */
async function addMessageToDOM(msg){
  const div=document.createElement('div'); div.classList.add('message');
  div.classList.add(msg.senderId==(currentUser&&currentUser.uid)?'mine':'their');
  let text=msg.text||''; text=text.replace(/@([^\s@]+)/g,(m,u)=>`<span class="mention">@${u}</span>`);
  if(msg.type=='file'&&msg.fileData){
    const mime=msg.fileType||'';
    if(mime.startsWith('image/')) text+=`<img src="${msg.fileData}" class="chat-img">`;
    else if(mime.startsWith('video/')) text+=`<video src="${msg.fileData}" class="chat-video" controls></video>`;
    else if(mime.startsWith('audio/')) text+=`<audio src="${msg.fileData}" class="chat-audio" controls></audio>`;
    else text+=`<a href="${msg.fileData}" download="${msg.fileName}">Attachment ${msg.fileName}</a>`;
  }
  const pfpSrc=msg.pfp||'https://placehold.co/40';
  div.innerHTML=`<img src="${pfpSrc}" class="pfp"><div class="content"><div class="meta">${msg.username||'unknown'}${msg.time?'- '+formatTime(msg.time):''}</div><div class="body">${text}</div></div>`;
  
  renderAdminControls(msg, div);

  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
  
  if(currentUser && msg.senderId!==currentUser.uid){
    const shouldNotify = document.visibilityState!=='visible';
    if(shouldNotify && Notification.permission==='granted'){
      try{ new Notification(msg.username,{body:msg.text||msg.fileName||'New message',icon:pfpSrc}); }catch(e){}
    }
  }
}
</script>
</body>
</html>
